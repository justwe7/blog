<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>学习笔记</title>
    <meta name="description" content="记录平时所接触到的知识点">
    
    
    <link rel="preload" href="/assets/css/0.styles.c2144717.css" as="style"><link rel="preload" href="/assets/js/app.264ba1d9.js" as="script"><link rel="preload" href="/assets/js/2.d12215aa.js" as="script"><link rel="preload" href="/assets/js/29.4bd01c6f.js" as="script"><link rel="prefetch" href="/assets/js/10.0d17d068.js"><link rel="prefetch" href="/assets/js/11.872832ac.js"><link rel="prefetch" href="/assets/js/12.d597da4b.js"><link rel="prefetch" href="/assets/js/13.685479be.js"><link rel="prefetch" href="/assets/js/14.bdfa49da.js"><link rel="prefetch" href="/assets/js/15.68ca9d46.js"><link rel="prefetch" href="/assets/js/16.5762fa0d.js"><link rel="prefetch" href="/assets/js/17.3f6883fa.js"><link rel="prefetch" href="/assets/js/18.88f67ec2.js"><link rel="prefetch" href="/assets/js/19.19e217df.js"><link rel="prefetch" href="/assets/js/20.8d680bd2.js"><link rel="prefetch" href="/assets/js/21.5144d2b5.js"><link rel="prefetch" href="/assets/js/22.e86ab87d.js"><link rel="prefetch" href="/assets/js/23.9d7fdf0d.js"><link rel="prefetch" href="/assets/js/24.d6172d3a.js"><link rel="prefetch" href="/assets/js/25.b9fbc0ce.js"><link rel="prefetch" href="/assets/js/26.6ea45017.js"><link rel="prefetch" href="/assets/js/27.b33dd473.js"><link rel="prefetch" href="/assets/js/28.5aa8acb9.js"><link rel="prefetch" href="/assets/js/3.a4ec70ce.js"><link rel="prefetch" href="/assets/js/30.b49ee00d.js"><link rel="prefetch" href="/assets/js/31.fabcaa0e.js"><link rel="prefetch" href="/assets/js/32.ed98704a.js"><link rel="prefetch" href="/assets/js/33.c7b75105.js"><link rel="prefetch" href="/assets/js/34.cffd858f.js"><link rel="prefetch" href="/assets/js/4.927f54a0.js"><link rel="prefetch" href="/assets/js/5.b236a21c.js"><link rel="prefetch" href="/assets/js/6.9819231b.js"><link rel="prefetch" href="/assets/js/7.041203ac.js"><link rel="prefetch" href="/assets/js/8.6905c82d.js"><link rel="prefetch" href="/assets/js/9.c1a5f5d5.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c2144717.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">学习笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/justwe7/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/justwe7/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基础概念</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>广度知识</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>深度知识</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/深度知识/chrome性能.html" class="sidebar-link">chrome性能</a></li><li><a href="/深度知识/vue实现原理.html" class="sidebar-link">vue实现原理</a></li><li><a href="/深度知识/vue生命周期.html" class="active sidebar-link">vue生命周期</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/深度知识/从0开始手写一个promise.html" class="sidebar-link">从0开始手写一个promise</a></li><li><a href="/深度知识/前端性能优化.html" class="sidebar-link">前端性能优化</a></li><li><a href="/深度知识/发布订阅模式.html" class="sidebar-link">发布订阅模式</a></li><li><a href="/深度知识/正则速查表.html" class="sidebar-link">正则速查表</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><ul><li><a href="#vue%e7%94%9f%e5%91%bd%e5%91%a8%e6%9c%9f">Vue生命周期</a></li> <li><a href="#vue%e7%9a%84%e5%a3%b0%e6%98%8e%e5%91%a8%e6%9c%9f%e5%90%84%e9%98%b6%e6%ae%b5">Vue的声明周期各阶段</a></li> <li><a href="#%e4%bb%8e%e6%ba%90%e7%a0%81%e6%9d%a5%e7%9c%8b">从源码来看</a></li> <li><a href="#%e6%a0%b9%e6%8d%aevue%e5%91%a8%e6%9c%9f%e6%80%bb%e7%bb%93%e4%bb%80%e4%b9%88%e6%97%b6%e5%80%99%e5%81%9a%e4%bb%80%e4%b9%88">根据vue周期总结什么时候做什么</a></li> <li><a href="#%e6%80%bb%e7%bb%93">总结</a></li></ul> <h3 id="vue生命周期"><a href="#vue生命周期" class="header-anchor">#</a> Vue生命周期</h3> <p>fork了一个仓库有时间缕一缕加点注释<a href="https://github.com/justwe7/vue" target="_blank" rel="noopener noreferrer">地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>图片来源于网络
<img src="/static/vue-lifecycle.png" alt="生命周期"></p> <h3 id="vue的声明周期各阶段"><a href="#vue的声明周期各阶段" class="header-anchor">#</a> Vue的声明周期各阶段</h3> <ul><li>beforeCreated，创建前，在数据观测和初始化事件还未开始</li> <li>created，创建后，完成数据观测，属性和方法的运算，初始化事件，$el属性还没有显示出来</li> <li>beforeMounted,载入前，在挂载开始之前被调用，相关的render函数首次被调用。实例已完成以下配置：编译模板，把data里面的数据和模板生成html，注意此时还没挂载到html页面上。</li> <li>mounted，载入后，在el被新创建的vm.$el替换，并挂载到实例上去之后调用。实例已完成如下的配置：用上面编译好的html内容替换el属性指向的DOM对象。完成模板中的html渲染到html页面中。此过程中进行ajax交互。</li> <li>beforeUpdate，更新前，在数据更新之前调用，发生在虚拟DOM重新渲染和打补丁之前。可以在该钩子中进一步更改状态，不会触发附加的冲渲染过程。</li> <li>uodated，更新后，在由于数据更改导致的虚拟dom重新渲染和打补丁之后调用。调用时，组件dom已经更新，所以可以执行依赖于dom的操作。然而在大多数情况下，应该避免在此期间更改状态，因为这可能会导致更新无限循环。该钩子在服务器端渲染期间不被调用</li> <li>beforeDestroy，销毁前，在实例销毁之前调用。实例仍然完全可用。</li> <li>destroyed，销毁后，在实例销毁之后调用。调用后，所有的事件监听器会被移除掉，所有的子实例也会被销毁。</li></ul> <h3 id="从源码来看"><a href="#从源码来看" class="header-anchor">#</a> 从源码来看</h3> <p>（一）new Vue之前，首先会初始化定义Vue构造函数的方法及属性</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">initMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span><span class="token comment">//初始化vue组件上一些如data created methods watch等 触发生命周期钩子函数：beforeCreate created</span>
<span class="token function">stateMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span><span class="token comment">//定义$data $props $set $delete $watch</span>
<span class="token function">eventsMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span><span class="token comment">//$on $emit $off $once</span>
<span class="token function">lifecycleMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span><span class="token comment">//定义更新 _update $forceUpdate $destory  触发生命周期钩子函数： 'beforeDestroy' , 'destroyed' , 'beforeMount' , 'beforeUpdate' ,'mounted', 'activated' , 'deactivated'</span>
<span class="token function">renderMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span><span class="token comment">//render函数 slot createElement调用</span>
</code></pre></div><p>（二）new Vue(opt)</p> <ol><li>在Vue构造函数之内会执行this._init
this._init主要执行了如下方法:</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">initLifecycle</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token comment">//justwe   设置$parent/$root/$refs/$children等关系值</span>
<span class="token function">initEvents</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token comment">//vm._events updateComponents  监听事件</span>
<span class="token function">initRender</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token comment">//vm._c vm.$createElement  初始化插槽 createElement方法声明</span>
<span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'beforeCreate'</span><span class="token punctuation">)</span><span class="token comment">// 生命周期通知</span>
<span class="token function">initInjections</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token comment">// resolve injections before data/props  justwe resolveInject  defineReactive 注入数据依赖</span>
<span class="token function">initState</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token comment">// initProps 初始化Methods data computed watch </span>
<span class="token function">initProvide</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token comment">// resolve provide after data/props   vm._provided 为后代提供数据</span>
<span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'created'</span><span class="token punctuation">)</span><span class="token comment">//生命周期</span>
</code></pre></div><p>最终会调用 <code>vm.$mount(vm.$options.el)</code> 挂载组件<br>
2. $mount根据el将template转为render字符串方法，然后挂载到options属性下面(web平台会多一步操作)</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">const</span> mount <span class="token operator">=</span> <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$mount<span class="token comment">//A</span>
  <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$mount</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    code<span class="token operator">...</span><span class="token comment">//B</span>
    <span class="token keyword">return</span> <span class="token function">mount</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> el<span class="token punctuation">,</span> hydrating<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p><strong>B代码块会转换template为render字符串:</strong><br> <img src="/static/vue-render2.png" alt="vue-render2"> <img src="/static/vue-render1.png" alt="vue-render1"></p> <ol><li>$mount会执行之前的 <code>Vue.prototype.$mount</code>方法，真实执行的是mountComponent方法，把当前的vm实例传入
mountComponent</li></ol> <ul><li>开始触发钩子 beforeMount</li> <li>定义updateComponent方法 最终调用update方法通过VNode生成真实dom，更新界面</li> <li>创建watcher并将updateComponent方法传入，根据之前getter/setter管理通知watcher响应视图</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">/* 
  vm.$vnode 如果为 null，则表明这不是一次组件的初始化过程，而是我们通过外部 new Vue 初始化过程。那么对于组件，它的 mounted 时机在哪儿呢？ 
  组件的 VNode patch 到 DOM 后，会执行 invokeInsertHook 函数，把 insertedVnodeQueue 里保存的钩子函数依次执行一遍，它的定义在 src/core/vdom/patch.js
  */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$vnode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    vm<span class="token punctuation">.</span>_isMounted <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'mounted'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="根据vue周期总结什么时候做什么"><a href="#根据vue周期总结什么时候做什么" class="header-anchor">#</a> 根据vue周期总结什么时候做什么</h3> <ul><li>在 <code>beforeCreate</code> 钩子函数调用的时候，是获取不到 <code>props</code> 或者 <code>data</code> 中的数据的，因为这些数据的初始化都在 initState</li> <li>然后会执行 created 钩子函数，在这一步的时候已经可以访问到之前不能访问到的数据，但是这时候组件还没被挂载，所以是看不到的。</li> <li>接下来会先执行 beforeMount 钩子函数，开始创建 VDOM，最后执行 mounted 钩子，并将 VDOM 渲染为真实 DOM 并且渲染数据。组件中如果有子组件的话，会递归挂载子组件，只有当所有子组件全部挂载完毕，才会执行根组件的挂载钩子。</li></ul> <blockquote><p>另外还有 keep-alive 独有的生命周期，分别为 activated 和 deactivated 。用 keep-alive 包裹的组件在切换时不会进行销毁，而是缓存到内存中并执行 deactivated 钩子函数，命中缓存渲染后会执行 actived 钩子函数。</p></blockquote> <ul><li>最后就是销毁组件的钩子函数 beforeDestroy 和 destroyed。前者适合移除事件、定时器等等，否则可能会引起内存泄露的问题。然后进行一系列的销毁操作，如果有子组件的话，也会递归销毁子组件，所有子组件都销毁完毕后才会执行根组件的 destroyed 钩子函数。</li></ul> <h3 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h3> <ol><li>new Vue会根据传入的option参数，初始化props，data，methods，watch，生命周期等，主要是实例一个Observer来进行数据劫持，主要是递归data使用defineReactive的核心代码Definepropty来getter setter</li> <li>compile会分析模板，将dom解析为AST，然后把不需要动态响应的打上静态的标记，然后使用render来将AST转为render function字符串。</li> <li>renderfunction渲染读取vue的插值表达式或v-xxx所对应值会触发getter，将值与Observer所劫持的值进行绑定，进行依赖收集。因为触发了getter所以可以在defineReactive处创建一个闭包，实例订阅发布的对象，setter的时候通知更新，getter来接受更新，这一步可以成为watcher</li> <li>数据更新时通过发布订阅通知watcher进行更新，watcher会调用_update方法执行__patch__传入_render生成的VNode进行dom更新，内部实现了diff比对等</li></ol></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/justwe7/blog/edit/feature/docs/深度知识/vue生命周期.md" target="_blank" rel="noopener noreferrer">纠正错误</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">最近提交:</span> <span class="time">1/13/2020, 2:41:37 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/深度知识/vue实现原理.html" class="prev">vue实现原理</a></span> <span class="next"><a href="/深度知识/从0开始手写一个promise.html">从0开始手写一个promise</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.264ba1d9.js" defer></script><script src="/assets/js/2.d12215aa.js" defer></script><script src="/assets/js/29.4bd01c6f.js" defer></script>
  </body>
</html>
